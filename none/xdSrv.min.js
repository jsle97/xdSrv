/* 
 * Jakub Åšledzikowski <jsledzikowski.web@gmail.com>
 */
import{createServer as H}from"http";import{stat,readFile}from"fs/promises";import{createReadStream as R}from"fs";import{resolve as P,extname as E}from"path";
let M={h:"text/html;charset=utf-8",j:"application/json;charset=utf-8",c:"text/css;charset=utf-8",s:"application/javascript;charset=utf-8"},methodMap={GET:"G",POST:"P",DELETE:"D",PUT:"U",HEAD:"H"},X=t=>{let p={G:[],P:[],D:[],U:[],H:[]},i=[],c=P(t?.s||"."),r=(t,e,r)=>{let a=null;if(e.includes(":")){let r=0;a=new RegExp("^"+e.replace(/:(\w+)/g,(t,e)=>`(?<${e}${1<++r?"r":""}>[^/]+)`)+"$")}p[methodMap[t]].push({p:e,r:a,h:r})},a=H(async(n,o)=>{var t=new URL(n.url,"http://"+(n.headers.host||"l"));n.p=t.pathname,n.q=Object.fromEntries(t.searchParams),o.j=t=>{o.setHeader("content-type",M.j),o.end(JSON.stringify(t))},o.s=t=>{"object"!=typeof t||Buffer.isBuffer(t)?o.end(String(t)):o.j(t)};await(()=>{let a=0,s=async()=>{if(a<i.length)try{await i[a].m(n,o,async()=>{a++,await s()})}catch(t){console.error(t),o.statusCode=500,o.end("Internal Server Error")}else{var t=((t,e)=>{for(var r of p[methodMap[t]]){if(r.p==e)return{h:r.h,p:{}};var a;if(r.r&&r.r.test(e))return a=e.match(r.r),{h:r.h,p:a?a.groups:{}}} })(n.method,n.p);if(t){if(n.params=t.p,"GET"!=n.method&&"DELETE"!=n.method){let e,r=[];n.on("data",t=>r.push(t)),await new Promise(t=>n.on("end",()=>{e=Buffer.concat(r).toString();try{n.body=JSON.parse(e)}catch{n.body=e}t()}))}return t.h(n,o)}t="/"==n.p?"/index.html":n.p;try{var e=P(c,"."+t),r=await stat(e);if(r.isFile())return o.setHeader("content-type",M[E(e).slice(1)]||"text/plain"),o.setHeader("content-length",r.size),void R(e).pipe(o)}catch{}o.statusCode=404,o.end("404")}};s()})()}),s={get:(t,e)=>(r("GET",t,e),s),post:(t,e)=>(r("POST",t,e),s),put:(t,e)=>(r("PUT",t,e),s),delete:(t,e)=>(r("DELETE",t,e),s),use:(t,e)=>("function"==typeof t&&(e=t,t="*"),i.push({p:t,m:e}),s),listen:(t,e)=>(console.log(`PORT: ${t}`),a.listen(t,e),a)};return s},xdSrv={build:X};
export default xdSrv;